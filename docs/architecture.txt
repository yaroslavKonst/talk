Encryption system
-----------------
Low level protocol. It is used on top of TCP connection.
| data block size (uint64_t) | data block |

Encryption protocol. It works on top of low level protocol.
Encrypted block structure:
| mac | nonce | message |

Encrypted blocks are sent scrambled.
Scrambled block structure:
| scrambler init (1 byte) | data |

Signed block structure:
| data | signature |

Timestamps are 64-bit signed integers that contain number of
seconds since the Epoch, 1970.01.01 00:00:00 UTC.

Handshake occurs when client connects the server.
During handshake client and server authenticate each other
and establish encrypted connection.

Server                                               Client
   |        <----------------------------------        |
   |              signed, then scrambled               |
   |        | client public key | timestamp 1 |        |
   |                                                   |
   |        ---------------------------------->        |
   |                     encrypted                     |
   |        | server public key | timestamp 2 |        |
   |                                                   |
   |        <----------------------------------        |
   |                     encrypted                     |
   |                  | timestamp 2 |                  |

Keep alive messages are sent periodically by the client to
check whether the connection is still in active state.
Server sends response upon receiving client's request.

Server                                               Client
   |        <----------------------------------        |
   |                     encrypted                     |
   |                  | timestamp 1 |                  |
   |                                                   |
   |        ---------------------------------->        |
   |                     encrypted                     |
   |                  | timestamp 1 |                  |

Control system
--------------
Control system does not use encryption and authentication because
control port is available only via UNIX socket and is not exposed
to the network.

Command structure:
  Command id (int32)   Command data
|      shutdown      |
|   get public key   |
|      add user      | key | signature | name size (int32) | name |
|    remove user     | key |
|     list users     |

Response structure.
shutdown         | no response
get public key   | result code | public key |
add user         | result code |
remove user      | result code |
list users       | result code | user count (int32) | key | name (55 bytes) |...

Message system
--------------
Message system uses encrypted data blocks during messasge delivery.
Message content is additionally encrypted using one time session keys
generated by sender and receiver for end to end encryption.

Message structure:
| sender key | receiver key | timestamp | index (int32_t) | encrypted data |
All unencrypted fields are signed.

Index field is used to distinguish messages sent during one second and
thus having the same timestamps.

Commands from client to server.
  command (int32)
|  text message   | message |
|   list users    |
|  get messages   | timestamp |

Response
text message | command id | status (int32) |
list users   | command id | user count (int32) | key | name (55 bytes) |...
get messages | no response

Commands from server to client.
| deliver message | message |

     response
deliver message | no response

Storage structure
-----------------
Files containing message data blocks.
/owner_key/storage/peer_key/index - index for fast search
/owner_key/storage/peer_key/in/timestamp_index - incoming message
/owner_key/storage/peer_key/out/timestamp_index - outgoing message

Message attributes.
/owner_key/attributes/peer_key/timestamp_index_{s,r}
Each file contains flags. If the file does not exist it means that all
flags are cleared.
Flag list: unread, unsent, fault.
unread: incoming message that has not been marked as read.
unsent: outgoing message that has not been sent.
fault: outgoing message that will not be sent due to permanent error
(invalid user keys etc.).

Contact book.
/owner_key/contacts/peer_key
Each file contains user name.

Client configuration.
/owner_key/talk.conf in ini format.
[base]
ProfileName
[connection]
ServerIP
ServerPort
ServerKey
